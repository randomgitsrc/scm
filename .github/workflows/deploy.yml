# è¶…çº§å¯†ç æœº - è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# åœ¨ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ° VPS

name: Deploy to VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: super-code/package-lock.json

      # å®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: Install and Build
        working-directory: ./super-code
        run: |
          npm ci
          npm run build

      # éƒ¨ç½²åˆ° VPS
      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          source: "super-code/dist/*"
          target: ${{ secrets.REMOTE_DIR || '/var/www/super-code' }}
          strip_components: 2
          rm: true

      # è®¾ç½®æƒé™
      - name: Set permissions
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |
            sudo chown -R www-data:www-data ${{ secrets.REMOTE_DIR || '/var/www/super-code' }}
            sudo chmod -R 755 ${{ secrets.REMOTE_DIR || '/var/www/super-code' }}
            sudo systemctl reload nginx
            echo "âœ… éƒ¨ç½²å®Œæˆ"

      # å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
          fi
